<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Real-time Like System</title>
    <!-- Include the Tailwind CSS CDN -->
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="p-10">
    <div class="flex justify-center">
        <div class="container mx-auto">
            {% for post in posts %}
              <div class="my-8 bg-white p-8 rounded-lg shadow-lg">
                <p class="text-gray-700">{{ post.content }}</p>
                <p class="text-gray-700">{{ post.like_count }} likes</p>
                <button class="bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded"
                        data-post-id="{{ post.id }}"
                        onclick="likePost(this)">Like</button>
              </div>
            {% endfor %}
          </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
       function connect(postId) {
        var socket = new WebSocket(`ws://${window.location.host}/ws/post/${postId}/like/`);
        console.log(socket)

        socket.onopen = function(e) {
            console.log("Successfully connected to the WebSocket.");
        }

        socket.onclose = function(e) {
            console.log("WebSocket connection closed unexpectedly. Trying to reconnect in 2s...");
            setTimeout(function() {
                console.log("Reconnecting...");
                connect(postId);
            }, 2000);
        };

  
      socket.onmessage = function(event) {
        console.log(event.data);
        var data = JSON.parse(event.data);
        var postId = data.post;
        var likeCount = data.like_count;
        $("button[data-post-id=" + postId + "]").siblings("p:last-of-type").text(likeCount + " likes");
      };
  
    }

    function likePost(button) {
    var postId = button.dataset.postId;
    connect(postId);
    $.ajax({
        type: "POST",
        url: "/like_post/" + postId + "/",
        headers: {
        "X-CSRFToken": "{{ csrf_token }}"
        },
        success: function(data) {
        $(button).siblings("p:last-of-type").text(data.like_count + " likes");
        }
    });
    }
    </script>
  </
